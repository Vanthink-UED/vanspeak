!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof module&&module.exports?module.exports=e():t.vanSpeak=t.vanspeak=t.Vanspeak=e()}(this,function(){function t(t,e){this.defaultOptions={rate:.7,volume:1,maxWordNum:100,speechStart:function(){},speechEnd:function(){},speechError:function(){console.warn("Voice not working!")}},this.iosVoiceInit===!1,this.utterances=[]}function e(){this.apis={single:"http://api.vanthink.cn/api/audio/index?t=",multi:"http://api.vanthink.cn/api/audio/multi?t=",sentence:"http://v.vanthink.cn/?tl=en-US&sv=&vn=&pitch=0.5&vol=1&t="},this.audioList=[],this.audioPlayedList=[],this.preloadAudioList=[],this.defaultOptions={rate:.7,volume:1,maxWordNum:100,speechStart:function(){},speechEnd:function(){},speechError:function(){console.warn("Voice not workong!")}},this.audio=new Audio,this.audio.style.width=0,this.audio.preload="auto",this.audio.style.position="absolute",this.audio.style.left="-5000px",this.audio.loop=!1,this.audio.setAttribute("id","tts");var t=this;"onended"in this.audio?this.audio.onended=function(e){t.audioPlayFinish(e)}:this.audio.addEventListener("timeupdate",function(e){this.currentTime==this.duration?(o.isUCBrowser()||(this.currentTime=0),this.pause(),t.audioPlayFinish(e)):t.isPlaying()||t.audio.play()}),document.body.appendChild(this.audio)}var i=function(t,e,i){if("function"==typeof i)for(var n in e)t[n]=i(t[n],e[n],n);else for(n in e)!i&&(t[n]||n in t)||(t[n]=e[n]);return t},n=function(t,e,i,n,s){function o(t){for(var e,i={},n=/([a-z\-]+):\s?(.*);?/gi;e=n.exec(t);)i[e[1]]=e[2];return i}var a=new XMLHttpRequest,r=this.error,u=!1;"blob"===t&&(u=t,t="GET"),t=t.toUpperCase(),a.onload=function(e){var i=a.response;try{i=JSON.parse(a.responseText)}catch(t){401===a.status&&(i=console.error("access_denied",a.statusText))}var n=o(a.getAllResponseHeaders());n.statusCode=a.status,(s=s||function(){})(i||("GET"===t?r("empty_response","Could not get resource"):{}),n)},a.onerror=function(t){var e=a.responseText;try{e=JSON.parse(a.responseText)}catch(t){}s&&s(e||console.error("access_denied","Could not get resource"))};var d;if("GET"===t||"DELETE"===t)n=null;else if(n&&"string"!=typeof n&&!(n instanceof FormData)&&!(n instanceof File)&&!(n instanceof Blob)){var h=new FormData;for(d in n)n.hasOwnProperty(d)&&(n[d]instanceof HTMLInputElement?"files"in n[d]&&n[d].files.length>0&&h.append(d,n[d].files[0]):n[d]instanceof Blob?h.append(d,n[d],n.name):h.append(d,n[d]));n=h}if(a.open(t,e,!0),u&&("responseType"in a?a.responseType=u:a.overrideMimeType("text/plain; charset=x-user-defined")),i)for(d in i)a.setRequestHeader(d,i[d]);return a.send(n),a},s=window.navigator.userAgent.toLowerCase(),o={isAndroid:function(){return s.indexOf("android")>-1},isIOS:function(){return/(iPad|iPhone|iPod)/gi.test(s)},isIOS9:function(){return/(iphone|ipod|ipad).* os 9_/.test(s)},isChrome:function(){return s.indexOf("chrome")>-1},isSafari:function(){return s.indexOf("safari")>-1&&!(s.indexOf("chrome")>-1)},isUCBrowser:function(){return s.indexOf("ucbrowser")>-1}},a={isWord:function(t,e){var e=e||120,i=e/2;return!(t.length>i)&&!!/^[a-zA-Z\d\._\-\']+$/.test(t)},groupWords:function(t,e){var i=e||100,n=[];if(t.length>i){for(var s=t;s.length>i;){var o=s.search(/[:!?.;。！；]+/),a="";if((o==-1||o>=i)&&(o=s.search(/[,]+/)),o==-1&&s.search(" ")==-1&&(o=99),o==-1||o>=i)for(var t=s.split(" "),r=0;r<t.length&&!(a.length+t[r].length+1>i);r++)a+=(0!=r?" ":"")+t[r];else a=s.substr(0,o+1);s=s.substr(a.length,s.length-a.length),n.push(a)}return s.length>0&&n.push(s),[n.join(" ")]}return[t]},getSpeechTime:function(t,e){var i=130,n=t;if(null===voice.timerSpeed&&(n=1),!(n<=0)){var s=e.split(/\s+/).length,o=(e.match(/[^ ]/gim)||e).length,a=o/s/5.1,r=1e3*n*(60/i)*a*s;return e<3&&(r=4e3),r<3e3&&(r=3e3),r}}};t.prototype={setVoices:function(t){function e(t,e,i){for(var n=0;n<e.length;n++)if(e[n].name==t)return e[n];for(var n=0;n<e.length;n++)if(e[n].lang==i)return e[n];return this.voice=!1}var i={us:[{name:"Google US English",default:!1,voiceURI:"Google US English",lang:"en-US",localService:!1},{name:"English United States",lang:"en_US"},{name:"en-US",rate:.2,pitch:1,timerSpeed:1.3},{name:"Samantha",voiceURI:"com.apple.speech.synthesis.voice.Samantha"}]},n={name:"en-US",voiceURI:"en-US",lang:"en-US"},s={name:"Samantha",voiceURI:"com.apple.ttsbundle.Samantha-premium",lang:"en-US",localService:!0,default:!0},a=null;return o.isChrome()&&(a=i.us[0]),o.isSafari()&&(a=i.us[3]),o.isAndroid()&&(a=i.us[1]),o.isIOS()&&(a=n),o.isIOS9()?(a=s,void(this.voice=a)):void(this.voice=e(a.name,t,a.lang))},say:function(t,e){if(this.options=i(this.defaultOptions,e),this.isPlaying()&&this.cancel(),o.isIOS9()&&this.iosVoiceInit===!1&&(setTimeout(function(){n.say(t,params)},100),n.startHandle()),!this.voice)return u.say(t);var n=this,s=!1;this.wordsGroup=a.groupWords(t);for(var r=0;r<this.wordsGroup.length;r++){var d=(n.wordsGroup[r],new SpeechSynthesisUtterance);this.voice.voiceURI&&(d.voice=this.voice,d.voiceURI=this.voice.voiceURI),d.volume=1,o.isIOS()?d.rate=(null!=this.options.rate?this.options.rate*this.options.rate:1)*d.rate:d.rate=(null!=this.options.rate?this.options.rate:1)*d.rate,d.pitch=n.selectBest([this.options.pitch,1]),d.text=this.wordsGroup[r],d.lang=this.voice.lang,d.rvIndex=r,d.rvTotal=this.wordsGroup.length,0==r&&(d.onstart=n.options.speechStart),this.options.onendcalled=!1,this.options.words=d.text,r<this.wordsGroup.length-1&&this.wordsGroup.length>1?(d.onend=this.onPartEnd.bind(this),d.hasOwnProperty("addEventListener")&&d.addEventListener("end",function(){n.onPartEnd()})):(d.onend=this.options.speechEnd,d.hasOwnProperty("addEventListener")&&d.addEventListener("end",this.options.speechEnd),d.onboundary=this.options.onboundary||n.onboundary.bind(n),d.volume=this.options.volume||d.volume),this.utterances.push(d),0==r&&(this.currentMsg=d),s=!0,this.runTTS(d)}return s},runTTS:function(t){var e=this;setTimeout(function(){e.cancelled=!1,speechSynthesis.speak(t)},.01)},cancel:function(){return this.checkAndCancelTimeout(),this.cancelled=!0,speechSynthesis.cancel(),this.cancelled},startHandle:function(){if(o.isIOS()&&!this.iosVoiceInit){var t=new SpeechSynthesisUtterance(" ");speechSynthesis.speak(t),this.iosVoiceInit=!0}},setVolume:function(t){for(var e=this.options.volume=t<=1?t:1,i=0;i<this.utterances.length;i++)this.utterances[i].volume=e},preAudio:function(){},isPlaying:function(){return speechSynthesis&&speechSynthesis.speaking},speechEnd:function(){this.options.speechEnd()},startTimeout:function(t,e){var i=a.getSpeechTime(this.voice.speed,t);this.timeoutId=setTimeout(e,i)},selectBest:function(t){for(var e=0;e<t.length;e++)if(null!=t[e])return t[e];return null},startTTS:function(){var t=this;this.onstartFired||(this.onstartFired=!0,(isIOS()||isSafari()||isAndroid())&&1===speakMode&&t.startTimeout(t.params.words,t.speech_timedout),t.params.onendcalled=!1,null!=t.params&&null!=t.params.onstart&&t.params.onstart())},endTTS:function(){return this.checkAndCancelTimeout(),this.cancelled===!0?void(this.cancelled=!1):void(null!=this.params&&null!=this.params.onend&&1!=this.params.onendcalled&&(this.params.onendcalled=!0,this.params.onend()))},onboundary:function(t){var e=this;isIOS()&&!e.onstartFired&&e.startTTS()},onPartEnd:function(t){null!=this.params&&null!=this.params.onchuckend&&this.params.onchuckend(),this.dispatch("OnPartEnd");var e=this.utterances.indexOf(t.utterance);this.currentMsg=this.utterances[e+1]},dispatch:function(t){var e=this;if(e.hasOwnProperty(t+"_callbacks")&&null!=e[t+"_callbacks"]&&e[t+"_callbacks"].length>0){for(var i=e[t+"_callbacks"],n=0;n<i.length;n++)i[n]();return!0}var s=t+"_callbacks_timeout",o=t+"_callbacks_timeoutCount";return e.hasOwnProperty(s)||(e[o]=10,e[s]=setInterval(function(){e[o]=e[o]-1,(e.dispatch(t)||e[o]<0)&&clearTimeout(e[s])},50)),!1},checkAndCancelTimeout:function(){null!=this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}},e.prototype={say:function(t,e){this.options=i(this.defaultOptions,e),this.isPlaying()&&this.cancel(),this.audioList.length>0&&this.clearAudio(),this.wordsGroup=a.groupWords(t);for(var n=0;n<this.wordsGroup.length;n++){var s=this.wordsGroup[n],o="",r=this.findPreLoadAudio(s);if(r!==!1)o=r.src,this.audioList.push({key:s,src:o}),this.isPlaying()||1!=this.audioList.length||(this.audioTrackIndex=0,this.playAudio());else{var u=this.options.rate/2;if(u=Math.min(Math.max(u,0),1),a.isWord(s)){var d=this,h=this.apis.sentence+"&rate="+u+"&t="+encodeURIComponent(s);this.playAudio(h,!0),this.getAudio("single",s,function(t){0==t.errcode&&(o=t.data,d.addPreLoadAudio(s,o))})}else{var h=this.apis.sentence+"&rate="+u+"&t="+encodeURIComponent(s);this.createAudio(s,h)}}}},setVolume:function(t){for(var e=this.options.volume=t<=1?t:1,i=0;i<this.audioList.length;i++)this.audioList[i].volume=e;for(var i=0;i<self.audioPlayedList.length;i++)self.audioPlayedList[i].volume=e;this.currentAudio.volume=e},cancel:function(){null!=this.currentAudio&&this.currentAudio.pause(),this.clearAudio()},startHandle:function(){console.log("audio inited")},preAudio:function(t){if(Array.isArray(t)){for(var e=[],i=0;i<t.length;i++)a.isWord(t[i])&&this.preloadAudioList.indexOf(t[i])==-1&&e.push(t[i]);var s=this;this.getAudio("multi",JSON.stringify(e),function(e){if(0==e.errcode)for(var i=0;i<e.data.length;i++)n("GET",e.data[i]),s.addPreLoadAudio(t[i],e.data[i])})}},isPlaying:function(){return null!=this.currentAudio&&!this.currentAudio.ended&&!this.currentAudio.paused},findPreLoadAudio:function(t){for(var e=0;e<this.preloadAudioList.length;e++)if(this.preloadAudioList[e].key===t)return this.preloadAudioList[e];return!1},addPreLoadAudio:function(t,e,i){var n=this.findPreLoadAudio(t);n||i||this.loadAudio(e),this.preloadAudioList.push({key:t,src:e})},createAudio:function(t,e){this.audioList.push({key:t,src:e}),this.addPreLoadAudio(t,e,!0),this.isPlaying()||1!=this.audioList.length||(this.audioTrackIndex=0,this.playAudio())},loadAudio:function(t){var e=document.createElement("iframe");e.style.position="absolute",e.style.width=0,e.style.left="-5000px",e.src=t,e.onload=function(){}},playAudio:function(t){var e=document.querySelector("#tts");if(t)e.src=t;else{if(this.audioTrackIndex==this.audioList.length)return void(e.src="");e.src=this.audioList[this.audioTrackIndex].src,this.audioPlayedList.push(this.audioList[this.audioTrackIndex])}setTimeout(function(){e.playbackRate=1},50),e.onloadedmetadata=function(){e.play()},e.play(),e.currentTime=0},audioPlayFinish:function(t){this.audioTrackIndex<=this.audioList.length-1&&(this.audioTrackIndex++,this.playAudio())},clearAudio:function(){return this.audioList=[]},getAudio:function(t,e,i,s){var o=this.apis[t]+encodeURIComponent(e)+"&_req="+(s?"":(new Date).getTime()+"."+Math.floor(1e4*Math.random()));n("GET",o,{},{},i)}};var r=null,u=new e;if("undefined"!=typeof window.speechSynthesis){var d=0,h=window.speechSynthesis.getVoices();r=new t(h),setTimeout(function(){var t=setInterval(function(){h=window.speechSynthesis.getVoices(),0==h.length?(d++,d>20&&(clearInterval(t),null!=window.speechSynthesis&&o.isIOS()&&r.setVoices(h))):(clearInterval(t),r.setVoices(h),r.voice||(r=u))},25)},100)}else r=u;return window.onbeforeunload=function(){try{r.cancel()}catch(t){console.log("page closed")}},r});