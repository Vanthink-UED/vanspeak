!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof module&&module.exports?module.exports=t():e.vanSpeak=e.vanspeak=e.Vanspeak=t()}(this,function(){var e=function(){function e(){"undefined"!=typeof window.speechSynthesis&&setTimeout(function(){var e=setInterval(function(){var n=window.speechSynthesis.getVoices();0==n.length?(f++,f>20&&(clearInterval(e),null!=window.speechSynthesis?s()&&(v=1,t(n)):(v=1,t(n)))):(clearInterval(e),v=2,t(n))},25)},100),setTimeout(function(){window.vanspeak.hiddenSendUserVoice()},2e3)}function t(e){return o()&&(g=i.us[0]),u()&&(g=i.us[3]),d()&&(g=i.us[1]),s()&&(g=h),r()?(g=l,void(y=g)):(d()&&!o()&&(v=2),window.allvoices=e,void(y=n(g.name,e,g.lang)))}function n(e,t,n){for(var i=0;i<t.length;i++)if(t[i].name==e)return t[i];for(var i=0;i<t.length;i++)if(t[i].lang==n)return t[i];return v=2,{}}var i={us:[{name:"Google US English",default:!1,voiceURI:"Google US English",lang:"en-US",localService:!1},{name:"English United States",lang:"en_US"},{name:"en-US",rate:.2,pitch:1,timerSpeed:1.3},{name:"Samantha",voiceURI:"com.apple.speech.synthesis.voice.Samantha"}],uk:[{name:"Google UK English Feale",flag:"gb",gender:"f"}]},a=window.navigator.userAgent.toLowerCase(),s=function(){return/(iPad|iPhone|iPod)/gi.test(a)},r=function(){return/(iphone|ipod|ipad).* os 9_/.test(a)},o=function(){return a.indexOf("chrome")>-1},u=function(){return a.indexOf("safari")>-1&&!o()},d=function(){return a.indexOf("android")>-1},h={name:"en-US",voiceURI:"en-US",lang:"en-US"},l={name:"Samantha",voiceURI:"com.apple.ttsbundle.Samantha-premium",lang:"en-US",localService:!0,default:!0},c={rate:.7,volume:1,maxWordNum:100},p=130,f=0,m={single:"http://api.vanthink.cn/api/audio/index?t=",multi:"http://api.vanthink.cn/api/audio/multi?t=",sentence:"http://v.vanthink.cn/?tl=en-US&sv=&vn=&pitch=0.5&vol=1&t="},v=2,g="",y="",T=!1;return e(),{say:function(e,t){var n=this;if(this.params=c,r()&&T===!1)return setTimeout(function(){n.say(e,t)},100),n.startHandle(),n.iOS9_initialized=!0;void 0===this.audioList&&(this.audioList=[]),this.isPlaying()&&this.cancel(),2===v&&this.audioList.length>0&&this.clearAudio(),this.groupWords(e);for(var i=0;i<this.wordsGroup.length;i++){var a=n.wordsGroup[i];if(1===v){var o=new SpeechSynthesisUtterance;y.voiceURI&&(o.voice=y,o.voiceURI=y.voiceURI),o.volume=1,s()?o.rate=(null!=this.params.rate?this.params.rate*this.params.rate:1)*o.rate:o.rate=(null!=this.params.rate?this.params.rate:1)*o.rate,o.pitch=n.selectBest([this.params.pitch,1]),o.text=this.wordsGroup[i],o.lang=g.lang,o.rvIndex=i,o.rvTotal=this.wordsGroup.length,0==i&&(o.onstart=n.speech_onstart),this.params.onendcalled=!1,this.params.words=o.text,null!=this.params?(i<this.wordsGroup.length-1&&this.wordsGroup.length>1?(o.onend=n.onPartEnd,o.hasOwnProperty("addEventListener")&&o.addEventListener("end",n.onPartEnd)):(o.onend=n.speech_onend,o.hasOwnProperty("addEventListener")&&o.addEventListener("end",n.speech_onend)),o.onerror=this.params.onerror||function(e){console.warn("voice not workong!")},o.onpause=this.params.onpause,o.onresume=this.params.onresume,o.onmark=this.params.onmark,o.onboundary=this.params.onboundary||n.onboundary.bind(n),o.pitch=this.params.pitch||o.pitch,o.volume=this.params.volume||o.volume):(o.onend=n.speech_onend,o.onerror=function(e){console.warn("voice not working")}),void 0===this.utterances&&(this.utterances=[]),this.utterances.push(o),0==i&&(this.currentMsg=o),this.runTTS(o)}else{var u="",d=this.findPreLoadAudio(a);if(d!==!1){u=d.src;var h=document.createElement("AUDIO");h.src=u,h.playbackRate=1,h.preload="auto",this.audioList.push(h),this.isPlaying()||1!=this.audioList.length||(n.audioTrackIndex=0,n.playAudio())}else if(this.isWord(e)){var l=m.single+encodeURIComponent(this.wordsGroup[i]);this.xhr("GET",l,{},{},function(e){0==e.errcode&&(u=e.data,n.createAudio(a,u))})}else{var p=this.selectBest([n.iOS9?1:null,c.rate,1]);p/=2,p=Math.min(Math.max(p,0),1);var l=m.sentence+"&rate="+p+"&t="+encodeURIComponent(this.wordsGroup[i]);n.createAudio(a,l)}}}},runTTS:function(e){var t=this;setTimeout(function(){t.cancelled=!1,speechSynthesis.speak(e)},.01)},isWord:function(e){return!(e.length>c.maxWordNum/2)&&!!/[a-zA-Z\d\._\-\']/.test(e)},groupWords:function(e){if(this.wordsGroup=[],e.length>c.maxWordNum){for(var t=e,n=c.maxWordNum;t.length>n;){var i=t.search(/[:!?.;。！；]+/),a="";if((i==-1||i>=n)&&(i=t.search(/[,]+/)),i==-1&&t.search(" ")==-1&&(i=99),i==-1||i>=n)for(var e=t.split(" "),s=0;s<e.length&&!(a.length+e[s].length+1>n);s++)a+=(0!=s?" ":"")+e[s];else a=t.substr(0,i+1);t=t.substr(a.length,t.length-a.length),this.wordsGroup.push(a)}t.length>0&&this.wordsGroup.push(t)}else this.wordsGroup.push(e)},selectBest:function(e){for(var t=0;t<e.length;t++)if(null!=e[t])return e[t];return null},startTTS:function(){var e=this;this.onstartFired||(this.onstartFired=!0,(s()||u()||d())&&1===v&&e.startTimeout(e.params.words,e.speech_timedout),e.params.onendcalled=!1,null!=e.params&&null!=e.params.onstart&&e.params.onstart())},endTTS:function(){return this.checkAndCancelTimeout(),this.cancelled===!0?void(this.cancelled=!1):void(null!=this.params&&null!=this.params.onend&&1!=this.params.onendcalled&&(this.params.onendcalled=!0,this.params.onend()))},startTimeout:function(e,t){var n=g.timerSpeed;if(null===g.timerSpeed&&(n=1),!(n<=0)){var i=e.split(/\s+/).length,a=(e.match(/[^ ]/gim)||e).length,s=a/i/5.1,r=1e3*n*(60/p)*s*i;e<3&&(r=4e3),r<3e3&&(r=3e3),this.timeoutId=setTimeout(t,r)}},startHandle:function(){if(s()&&!T){var e=new SpeechSynthesisUtterance(" ");speechSynthesis.speak(e),T=!0}},onboundary:function(e){var t=this;s()&&!t.onstartFired&&t.startTTS()},onPartEnd:function(e){null!=this.params&&null!=this.params.onchuckend&&this.params.onchuckend(),this.Dispatch("OnPartEnd");var t=this.utterances.indexOf(e.utterance);this.currentMsg=this.utterances[t+1]},Dispatch:function(e){var t=this;if(t.hasOwnProperty(e+"_callbacks")&&null!=t[e+"_callbacks"]&&t[e+"_callbacks"].length>0){for(var n=t[e+"_callbacks"],i=0;i<n.length;i++)n[i]();return!0}var a=e+"_callbacks_timeout",s=e+"_callbacks_timeoutCount";return t.hasOwnProperty(a)||(t[s]=10,t[a]=setInterval(function(){t[s]=t[s]-1,(t.Dispatch(e)||t[s]<0)&&clearTimeout(t[a])},50)),!1},createAudio:function(e,t){var n=document.createElement("AUDIO");n.src=t,n.playbackRate=1,n.preload="auto",n.load(),void 0===this.audioList&&(self.audioList=[]),this.audioList.push(n),this.addPreLoadAudio(e,t),this.isPlaying()||1!=this.audioList.length||(this.audioTrackIndex=0,this.playAudio())},playAudio:function(){if(0==this.audioTrackIndex,this.audioTrackIndex!=this.audioList.length){this.currentAudio=this.audioList[this.audioTrackIndex];var e=this.currentAudio;Array.isArray(this.audioPlayedList)||(this.audioPlayedList=[]),this.audioPlayedList.push(e),setTimeout(function(){e.playbackRate=1},50),e.onloadedmetadata=function(){e.play()},this.currentAudio.play(),this.currentAudio.addEventListener("ended",this.audioPlayFinish.bind(this))}},audioPlayFinish:function(e){this.checkAndCancelTimeout(),this.audioTrackIndex<=this.audioList.length-1?(this.audioTrackIndex++,this.playAudio()):this.endTTS()},checkAndCancelTimeout:function(){null!=this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)},isPlaying:function(){return 2===v?null!=this.currentAudio&&!this.currentAudio.ended&&!this.currentAudio.paused:speechSynthesis.speaking},setVolume:function(e){if(this.isPlaying())if(2==v){for(var t=0;t<this.audioList.length;t++)this.audioList[t].volume=e;for(var t=0;t<self.audioPlayedList.length;t++)self.audioPlayedList[t].volume=e;this.currentAudio.volume=e}else for(var t=0;t<self.utterances.length;t++)this.utterances[t].volume=e},cancel:function(){this.checkAndCancelTimeout(),2==v?(null!=this.currentAudio&&this.currentAudio.pause(),this.clearAudio()):(this.cancelled=!0,speechSynthesis.cancel())},clearAudio:function(){return this.audioList=[]},preAudio:function(e){if(1!=v&&Array.isArray(e)){var t=[];Array.isArray(this.preloadAudioList)||(this.preloadAudioList=[]);for(var n=0;n<e.length;n++)this.isWord(e[n])&&this.preloadAudioList.indexOf(e[n])!=-1&&t.push(e[n]);var i=this,a=(new Date).getTime()+"."+Math.floor(1e4*Math.random()),s=m.multi+encodeURIComponent(JSON.stringify(e))+"&_req="+a;this.xhr("GET",s,{},{},function(t){if(0==t.errcode)for(var n=0;n<t.data.length;n++)i.xhr("GET",t.data[n]),i.addPreLoadAudio(e[n],t.data[n])})}},findPreLoadAudio:function(e){if(void 0==this.preloadAudioList)return!1;for(var t=0;t<this.preloadAudioList.length;t++)if(this.preloadAudioList[t].key===e)return this.preloadAudioList[t];return!1},addPreLoadAudio:function(e,t){void 0==this.preloadAudioList&&(this.preloadAudioList=[]),this.preloadAudioList.push({key:e,src:t})},xhr:function(e,t,n,i,a){function s(e){for(var t,n={},i=/([a-z\-]+):\s?(.*);?/gi;t=i.exec(e);)n[t[1]]=t[2];return n}var r=new XMLHttpRequest,o=this.error,u=!1;"blob"===e&&(u=e,e="GET"),e=e.toUpperCase(),r.onload=function(t){var n=r.response;try{n=JSON.parse(r.responseText)}catch(e){401===r.status&&(n=console.error("access_denied",r.statusText))}var i=s(r.getAllResponseHeaders());i.statusCode=r.status,(a=a||function(){})(n||("GET"===e?o("empty_response","Could not get resource"):{}),i)},r.onerror=function(e){var t=r.responseText;try{t=JSON.parse(r.responseText)}catch(e){}a&&a(t||console.error("access_denied","Could not get resource"))};var d;if("GET"===e||"DELETE"===e)i=null;else if(i&&"string"!=typeof i&&!(i instanceof FormData)&&!(i instanceof File)&&!(i instanceof Blob)){var h=new FormData;for(d in i)i.hasOwnProperty(d)&&(i[d]instanceof HTMLInputElement?"files"in i[d]&&i[d].files.length>0&&h.append(d,i[d].files[0]):i[d]instanceof Blob?h.append(d,i[d],i.name):h.append(d,i[d]));i=h}if(r.open(e,t,!0),u&&("responseType"in r?r.responseType=u:r.overrideMimeType("text/plain; charset=x-user-defined")),n)for(d in n)r.setRequestHeader(d,n[d]);return r.send(i),r},hiddenSendUserVoice:function(e){var t=this;setTimeout(function(){e=Array.isArray(window.allvoices)?allvoices:[];var n=e.map(function(e){return"_name:"+e.name+";_voiceURI:"+e.voiceURI||"****;"});t.xhr("POST","http://test.platform.vanthink.cn/api/voice/add",{},{voice:"speech:"+(1==v?"enable":"NOT SUPPORT!")+"\r\n voiceInfo:"+n})},2e4)}}}();return window.vanspeak=window.vamSpeak=e});