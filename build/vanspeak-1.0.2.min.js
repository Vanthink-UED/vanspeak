!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof module&&module.exports?module.exports=t():e.vanSpeak=e.vanspeak=e.Vanspeak=t()}(this,function(){function e(e,t){this.defaultOptions={rate:.7,volume:1,maxWordNum:100,speechStart:function(){},speechEnd:function(){},speechError:function(){console.warn("Voice not working!")}},this.iosVoiceInit===!1,this.utterances=[]}function t(){this.apis={single:"http://api.vanthink.cn/api/audio/index?t=",multi:"http://api.vanthink.cn/api/audio/multi?t=",sentence:"http://v.vanthink.cn/?tl=en-US&sv=&vn=&pitch=0.5&vol=1&t="},this.audioList=[],this.audioPlayedList=[],this.preloadAudioList=[],this.defaultOptions={rate:.7,volume:1,maxWordNum:100,speechStart:function(){},speechEnd:function(){},speechError:function(){console.warn("Voice not workong!")}}}var i=function(e,t,i){if("function"==typeof i)for(var n in t)e[n]=i(e[n],t[n],n);else for(n in t)!i&&(e[n]||n in e)||(e[n]=t[n]);return e},n=function(e,t,i,n,s){function o(e){for(var t,i={},n=/([a-z\-]+):\s?(.*);?/gi;t=n.exec(e);)i[t[1]]=t[2];return i}var a=new XMLHttpRequest,r=this.error,u=!1;"blob"===e&&(u=e,e="GET"),e=e.toUpperCase(),a.onload=function(t){var i=a.response;try{i=JSON.parse(a.responseText)}catch(e){401===a.status&&(i=console.error("access_denied",a.statusText))}var n=o(a.getAllResponseHeaders());n.statusCode=a.status,(s=s||function(){})(i||("GET"===e?r("empty_response","Could not get resource"):{}),n)},a.onerror=function(e){var t=a.responseText;try{t=JSON.parse(a.responseText)}catch(e){}s&&s(t||console.error("access_denied","Could not get resource"))};var c;if("GET"===e||"DELETE"===e)n=null;else if(n&&"string"!=typeof n&&!(n instanceof FormData)&&!(n instanceof File)&&!(n instanceof Blob)){var h=new FormData;for(c in n)n.hasOwnProperty(c)&&(n[c]instanceof HTMLInputElement?"files"in n[c]&&n[c].files.length>0&&h.append(c,n[c].files[0]):n[c]instanceof Blob?h.append(c,n[c],n.name):h.append(c,n[c]));n=h}if(a.open(e,t,!0),u&&("responseType"in a?a.responseType=u:a.overrideMimeType("text/plain; charset=x-user-defined")),i)for(c in i)a.setRequestHeader(c,i[c]);return a.send(n),a},s=window.navigator.userAgent.toLowerCase(),o={isAndroid:function(){return s.indexOf("android")>-1},isIOS:function(){return/(iPad|iPhone|iPod)/gi.test(s)},isIOS9:function(){return/(iphone|ipod|ipad).* os 9_/.test(s)},isChrome:function(){return s.indexOf("chrome")>-1},isSafari:function(){return s.indexOf("safari")>-1&&!(s.indexOf("chrome")>-1)}},a={isWord:function(e,t){var t=t||120,i=t/2;return!(e.length>i)&&!!/^[a-zA-Z\d\._\-\']+$/.test(e)},groupWords:function(e,t){var i=t||100,n=[];if(e.length>i){for(var s=e;s.length>i;){var o=s.search(/[:!?.;。！；]+/),a="";if((o==-1||o>=i)&&(o=s.search(/[,]+/)),o==-1&&s.search(" ")==-1&&(o=99),o==-1||o>=i)for(var e=s.split(" "),r=0;r<e.length&&!(a.length+e[r].length+1>i);r++)a+=(0!=r?" ":"")+e[r];else a=s.substr(0,o+1);s=s.substr(a.length,s.length-a.length),n.push(a)}return s.length>0&&n.push(s),n}return[e]},getSpeechTime:function(e,t){var i=130,n=e;if(null===voice.timerSpeed&&(n=1),!(n<=0)){var s=t.split(/\s+/).length,o=(t.match(/[^ ]/gim)||t).length,a=o/s/5.1,r=1e3*n*(60/i)*a*s;return t<3&&(r=4e3),r<3e3&&(r=3e3),r}}};e.prototype={setVoices:function(e){function t(e,t,i){for(var n=0;n<t.length;n++)if(t[n].name==e)return t[n];for(var n=0;n<t.length;n++)if(t[n].lang==i)return t[n];return this.voice=!1}var i={us:[{name:"Google US English",default:!1,voiceURI:"Google US English",lang:"en-US",localService:!1},{name:"English United States",lang:"en_US"},{name:"en-US",rate:.2,pitch:1,timerSpeed:1.3},{name:"Samantha",voiceURI:"com.apple.speech.synthesis.voice.Samantha"}],uk:[{name:"Google UK English Feale",flag:"gb",gender:"f"}]},n={name:"en-US",voiceURI:"en-US",lang:"en-US"},s={name:"Samantha",voiceURI:"com.apple.ttsbundle.Samantha-premium",lang:"en-US",localService:!0,default:!0},a=null;return o.isChrome()&&(a=i.us[0]),o.isSafari()&&(a=i.us[3]),o.isAndroid()&&(a=i.us[1]),o.isIOS()&&(a=n),o.isIOS9()?(a=s,void(this.voice=a)):void(this.voice=t(a.name,e,a.lang))},say:function(e,t){if(this.options=i(this.defaultOptions,t),this.isPlaying()&&this.cancel(),o.isIOS9()&&this.iosVoiceInit===!1&&(setTimeout(function(){n.say(e,params)},100),n.startHandle()),!this.voice)return u.say(e);var n=this,s=!1;this.wordsGroup=a.groupWords(e);for(var r=0;r<this.wordsGroup.length;r++){var c=(n.wordsGroup[r],new SpeechSynthesisUtterance);this.voice.voiceURI&&(c.voice=this.voice,c.voiceURI=this.voice.voiceURI),c.volume=1,o.isIOS()?c.rate=(null!=this.options.rate?this.options.rate*this.options.rate:1)*c.rate:c.rate=(null!=this.options.rate?this.options.rate:1)*c.rate,c.pitch=n.selectBest([this.options.pitch,1]),c.text=this.wordsGroup[r],c.lang=this.voice.lang,c.rvIndex=r,c.rvTotal=this.wordsGroup.length,0==r&&(c.onstart=n.options.speechStart),this.options.onendcalled=!1,this.options.words=c.text,r<this.wordsGroup.length-1&&this.wordsGroup.length>1?(c.onend=this.onPartEnd.bind(this),c.hasOwnProperty("addEventListener")&&c.addEventListener("end",function(){n.onPartEnd()})):(c.onend=this.options.speechEnd,c.hasOwnProperty("addEventListener")&&c.addEventListener("end",this.options.speechEnd),c.onboundary=this.options.onboundary||n.onboundary.bind(n),c.volume=this.options.volume||c.volume),this.utterances.push(c),0==r&&(this.currentMsg=c),s=!0,this.runTTS(c)}return s},runTTS:function(e){var t=this;setTimeout(function(){t.cancelled=!1,speechSynthesis.speak(e)},.01)},cancel:function(){return this.checkAndCancelTimeout(),this.cancelled=!0,speechSynthesis.cancel(),this.cancelled},startHandle:function(){if(o.isIOS()&&!this.iosVoiceInit){var e=new SpeechSynthesisUtterance(" ");speechSynthesis.speak(e),this.iosVoiceInit=!0}},setVolume:function(e){for(var t=this.options.volume=e<=1?e:1,i=0;i<this.utterances.length;i++)this.utterances[i].volume=t},preAudio:function(){},isPlaying:function(){return speechSynthesis&&speechSynthesis.speaking},speechEnd:function(){this.options.speechEnd()},startTimeout:function(e,t){var i=a.getSpeechTime(this.voice.speed,e);this.timeoutId=setTimeout(t,i)},selectBest:function(e){for(var t=0;t<e.length;t++)if(null!=e[t])return e[t];return null},startTTS:function(){var e=this;this.onstartFired||(this.onstartFired=!0,(isIOS()||isSafari()||isAndroid())&&1===speakMode&&e.startTimeout(e.params.words,e.speech_timedout),e.params.onendcalled=!1,null!=e.params&&null!=e.params.onstart&&e.params.onstart())},endTTS:function(){return this.checkAndCancelTimeout(),this.cancelled===!0?void(this.cancelled=!1):void(null!=this.params&&null!=this.params.onend&&1!=this.params.onendcalled&&(this.params.onendcalled=!0,this.params.onend()))},onboundary:function(e){var t=this;isIOS()&&!t.onstartFired&&t.startTTS()},onPartEnd:function(e){null!=this.params&&null!=this.params.onchuckend&&this.params.onchuckend(),this.dispatch("OnPartEnd");var t=this.utterances.indexOf(e.utterance);this.currentMsg=this.utterances[t+1]},dispatch:function(e){var t=this;if(t.hasOwnProperty(e+"_callbacks")&&null!=t[e+"_callbacks"]&&t[e+"_callbacks"].length>0){for(var i=t[e+"_callbacks"],n=0;n<i.length;n++)i[n]();return!0}var s=e+"_callbacks_timeout",o=e+"_callbacks_timeoutCount";return t.hasOwnProperty(s)||(t[o]=10,t[s]=setInterval(function(){t[o]=t[o]-1,(t.dispatch(e)||t[o]<0)&&clearTimeout(t[s])},50)),!1},checkAndCancelTimeout:function(){null!=this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}},t.prototype={say:function(e,t){this.options=i(this.defaultOptions,t),this.isPlaying()&&this.cancel(),this.audioList.length>0&&this.clearAudio(),this.wordsGroup=a.groupWords(e);for(var n=0;n<this.wordsGroup.length;n++){var s=this.wordsGroup[n],o="",r=this.findPreLoadAudio(s);if(r!==!1){o=r.src;var u=document.createElement("AUDIO");u.src=o,u.playbackRate=1,u.preload="auto",this.audioList.push(u),this.isPlaying()||1!=this.audioList.length||(this.audioTrackIndex=0,this.playAudio())}else if(a.isWord(s)){var c=this;this.getAudio("single",s,function(e){0==e.errcode&&(o=e.data,c.createAudio(s,o))})}else{var h=this.options.rate/2;h=Math.min(Math.max(h,0),1);var d=this.apis.sentence+"&rate="+h+"&t="+encodeURIComponent(s);this.createAudio(s,d)}}},setVolume:function(e){for(var t=this.options.volume=e<=1?e:1,i=0;i<this.audioList.length;i++)this.audioList[i].volume=t;for(var i=0;i<self.audioPlayedList.length;i++)self.audioPlayedList[i].volume=t;this.currentAudio.volume=t},cancel:function(){null!=this.currentAudio&&this.currentAudio.pause(),this.clearAudio()},startHandle:function(){console.log("audio inited")},preAudio:function(e){if(Array.isArray(e)){for(var t=[],i=0;i<e.length;i++)a.isWord(e[i])&&this.preloadAudioList.indexOf(e[i])!=-1&&t.push(e[i]);var s=this;this.getAudio("multi",JSON.stringify(t),function(t){if(0==t.errcode)for(var i=0;i<t.data.length;i++)n("GET",t.data[i]),s.addPreLoadAudio(e[i],t.data[i])})}},isPlaying:function(){return null!=this.currentAudio&&!this.currentAudio.ended&&!this.currentAudio.paused},findPreLoadAudio:function(e){for(var t=0;t<this.preloadAudioList.length;t++)if(this.preloadAudioList[t].key===e)return this.preloadAudioList[t];return!1},addPreLoadAudio:function(e,t){this.preloadAudioList.push({key:e,src:t})},createAudio:function(e,t){var i=document.createElement("AUDIO");i.src=t,i.playbackRate=1,i.preload="auto",i.load(),this.audioList.push(i),this.addPreLoadAudio(e,t),this.isPlaying()||1!=this.audioList.length||(this.audioTrackIndex=0,this.playAudio())},playAudio:function(){if(this.audioTrackIndex!=this.audioList.length){this.currentAudio=this.audioList[this.audioTrackIndex];var e=this.currentAudio;this.audioPlayedList.push(e),setTimeout(function(){e.playbackRate=1},50),e.onloadedmetadata=function(){e.play()},this.currentAudio.play(),this.currentAudio.addEventListener("ended",this.audioPlayFinish.bind(this))}},audioPlayFinish:function(e){this.audioTrackIndex<=this.audioList.length-1&&(this.audioTrackIndex++,this.playAudio())},clearAudio:function(){return this.audioList=[]},getAudio:function(e,t,i,s){var o=this.apis[e]+encodeURIComponent(t)+"&_req="+(s?"":(new Date).getTime()+"."+Math.floor(1e4*Math.random()));n("GET",o,{},{},i)}};var r=null,u=new t;if("undefined"!=typeof window.speechSynthesis){var c=0,h=window.speechSynthesis.getVoices();r=new e(h),setTimeout(function(){var e=setInterval(function(){h=window.speechSynthesis.getVoices(),0==h.length?(c++,c>20&&(clearInterval(e),null!=window.speechSynthesis&&o.isIOS()&&r.setVoices(h))):(clearInterval(e),r.setVoices(h),r.voice||(r=u))},25)},100)}else r=u;return window.onbeforeunload=function(){try{r.cancel()}catch(e){console.log("page closed")}},r});